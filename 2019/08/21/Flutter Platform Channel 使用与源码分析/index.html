<!DOCTYPE html>
<html lang=zh>
<head>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0e76dffc6c1c980a49f2d1fa69fd8148";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Flutter Platform Channel 使用与源码分析1. 为什么要有 PlatformChannel1、如果 Flutter 要获取设备的电量信息怎么办？2、如果 Flutter 要实时监控网络状态怎么办？ 由于 Flutter 特点如下：  Flutter is Google’s UI toolkit for building beautiful, natively compiled">
<meta property="og:type" content="article">
<meta property="og:title" content="Flutter Platform Channel 使用与源码分析">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;08&#x2F;21&#x2F;Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90&#x2F;index.html">
<meta property="og:site_name" content="九点下班">
<meta property="og:description" content="Flutter Platform Channel 使用与源码分析1. 为什么要有 PlatformChannel1、如果 Flutter 要获取设备的电量信息怎么办？2、如果 Flutter 要实时监控网络状态怎么办？ 由于 Flutter 特点如下：  Flutter is Google’s UI toolkit for building beautiful, natively compiled">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;p0.qhimg.com&#x2F;t01b3f704dcfed0e4ab.png">
<meta property="og:image" content="https:&#x2F;&#x2F;flutter.dev&#x2F;images&#x2F;PlatformChannels.png">
<meta property="og:image" content="http:&#x2F;&#x2F;p0.qhimg.com&#x2F;t01d0c790e129c2c8f9.png">
<meta property="og:image" content="http:&#x2F;&#x2F;p0.qhimg.com&#x2F;t01d23cfd7ce4e80077.png">
<meta property="og:updated_time" content="2019-10-22T13:51:09.981Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;p0.qhimg.com&#x2F;t01b3f704dcfed0e4ab.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Flutter Platform Channel 使用与源码分析</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/project/">项目</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2019/01/20/%E5%98%BF%EF%BC%8C%E5%85%84%E5%BC%9F%EF%BC%81%E7%A7%BB%E5%8A%A8%E7%AB%AF%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7Flipper%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&text=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&is_video=false&description=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Flutter Platform Channel 使用与源码分析&body=Check out this article: http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&name=Flutter Platform Channel 使用与源码分析&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flutter-Platform-Channel-使用与源码分析"><span class="toc-number">1.</span> <span class="toc-text">Flutter Platform Channel 使用与源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-为什么要有-PlatformChannel"><span class="toc-number">1.1.</span> <span class="toc-text">1. 为什么要有 PlatformChannel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-架构图"><span class="toc-number">1.2.</span> <span class="toc-text">2. 架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-PlatformChannel-类型"><span class="toc-number">1.3.</span> <span class="toc-text">3. PlatformChannel 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-channel-name"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 channel name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-codec"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 codec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-binaryMessenger"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 binaryMessenger</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-PlatformChannel-使用"><span class="toc-number">1.4.</span> <span class="toc-text">4. PlatformChannel 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-MethodChannel"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 MethodChannel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-BasicMessageChannel"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 BasicMessageChannel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-EventChannel"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 EventChannel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-总结"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-源码分析-以-MethodChannel-为例"><span class="toc-number">1.5.</span> <span class="toc-text">5. 源码分析-以 MethodChannel 为例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-调用-MethodChannel-的-invokeMethod-方法，会调用到-binaryMessenger-send-方法。即-binaryMessenger-send-传入-channel-name-和编码好的参数。"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">5.1 调用 MethodChannel 的 invokeMethod 方法，会调用到 binaryMessenger.send 方法。即 binaryMessenger.send 传入 channel name 和编码好的参数。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-binary-messenger-dart-的-send-方法会调用当前对象的-sendPlatformMessage-方法，最终会调用-window-sendPlatformMessage-方法。"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">5.2 binary_messenger.dart 的 send 方法会调用当前对象的 _sendPlatformMessage 方法，最终会调用 window.sendPlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-在-window-dart-中又调用了-native-方法-sendPlatformMessage。"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">5.3 在 window.dart 中又调用了 native 方法 _sendPlatformMessage。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-接下来进入-engine-中的-window-cc，可以看到最终调用的是-dart-state-gt-window-gt-client-gt-HandlePlatformMessage。"><span class="toc-number">1.5.0.4.</span> <span class="toc-text">5.4 接下来进入 engine 中的 window.cc，可以看到最终调用的是 dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-我们进入-window-h-中找到-client-其实是-WindowClient。"><span class="toc-number">1.5.0.5.</span> <span class="toc-text">5.5 我们进入 window.h 中找到 client 其实是 WindowClient。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-6-在-runtime-controller-h-中可以看到-RuntimeController-是-WindowClient-的实际实现，调用的是-RuntimeController-的-HandlePlatformMessage-方法。"><span class="toc-number">1.5.0.6.</span> <span class="toc-text">5.6 在 runtime_controller.h 中可以看到 RuntimeController 是 WindowClient 的实际实现，调用的是 RuntimeController 的 HandlePlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-7-在-runtime-controller-cc-中，HandlePlatformMessage-调用了-client-的-HandlePlatformMessage-方法，client-实际是代理对象-RuntimeDelegate。"><span class="toc-number">1.5.0.7.</span> <span class="toc-text">5.7 在 runtime_controller.cc 中，HandlePlatformMessage 调用了 client_ 的 HandlePlatformMessage 方法，client_ 实际是代理对象 RuntimeDelegate。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-8-engine-h-是-RuntimeDelegate-的具体实现类。"><span class="toc-number">1.5.0.8.</span> <span class="toc-text">5.8 engine.h 是 RuntimeDelegate 的具体实现类。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-9-engine-cc-中调用了-delegate-的-OnEngineHandlePlatformMessage-方法。"><span class="toc-number">1.5.0.9.</span> <span class="toc-text">5.9 engine.cc 中调用了 delegate_ 的 OnEngineHandlePlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-10-shell-h-是-Engine-的代理。"><span class="toc-number">1.5.0.10.</span> <span class="toc-text">5.10 shell.h 是 Engine 的代理。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-11-调用流程又进入了-shell-cc-的-HandleEngineSkiaMessage-方法，把消费放到-TaskRunner-中。"><span class="toc-number">1.5.0.11.</span> <span class="toc-text">5.11 调用流程又进入了 shell.cc 的 HandleEngineSkiaMessage 方法，把消费放到 TaskRunner 中。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-12-当-task-执行是会调用-platform-view-android-h-的-HandlePlatformMessage-方法。"><span class="toc-number">1.5.0.12.</span> <span class="toc-text">5.12 当 task 执行是会调用 platform_view_android.h 的 HandlePlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-13-在-platform-view-android-cc-的-HandlePlatformMessage-中，开始通过-jni-调用-java-端的方法，java-channel-即要找的-channel。"><span class="toc-number">1.5.0.13.</span> <span class="toc-text">5.13 在 platform_view_android.cc 的 HandlePlatformMessage 中，开始通过 jni 调用 java 端的方法，java_channel 即要找的 channel。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-14-在-platform-view-android-jni-cc-中可以看到-g-handle-platform-message-method-就是-FindClass-“io-flutter-embedding-engine-FlutterJNI”-类的-handlePlatformMessage-方法。至此-engine-代码执行结束。"><span class="toc-number">1.5.0.14.</span> <span class="toc-text">5.14 在 platform_view_android_jni.cc 中可以看到 g_handle_platform_message_method 就是 FindClass(“io/flutter/embedding/engine/FlutterJNI”) 类的 handlePlatformMessage 方法。至此 engine 代码执行结束。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-15-在-FlutterJNI-中调用了-this-platformMessageHandler-handleMessageFromDart-方法。也就是-DartMessenger-的-handleMessageFromDart-方法。"><span class="toc-number">1.5.0.15.</span> <span class="toc-text">5.15 在 FlutterJNI 中调用了 this.platformMessageHandler.handleMessageFromDart 方法。也就是 DartMessenger 的 handleMessageFromDart 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-16-DartMessenger-中-messageHandlers-通过-channel-名找到对应的-handler-进行处理，这个-handler-就是我们在-java-代码里通过-channel-设置的，整个调用流程完成。"><span class="toc-number">1.5.0.16.</span> <span class="toc-text">5.16 DartMessenger 中 messageHandlers 通过 channel 名找到对应的 handler 进行处理，这个 handler 就是我们在 java 代码里通过 channel 设置的，整个调用流程完成。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo-地址"><span class="toc-number">1.6.</span> <span class="toc-text">Demo 地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资源"><span class="toc-number">1.7.</span> <span class="toc-text">参考资源</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Flutter Platform Channel 使用与源码分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">九点下班</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-08-21T13:49:25.000Z" itemprop="datePublished">2019-08-21</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Flutter-Platform-Channel-使用与源码分析"><a href="#Flutter-Platform-Channel-使用与源码分析" class="headerlink" title="Flutter Platform Channel 使用与源码分析"></a>Flutter Platform Channel 使用与源码分析</h2><h3 id="1-为什么要有-PlatformChannel"><a href="#1-为什么要有-PlatformChannel" class="headerlink" title="1. 为什么要有 PlatformChannel"></a>1. 为什么要有 PlatformChannel</h3><p>1、如果 Flutter 要获取设备的电量信息怎么办？</br><br>2、如果 Flutter 要实时监控网络状态怎么办？</br></p>
<p>由于 Flutter 特点如下：</p>
<blockquote>
<p>Flutter is Google’s UI toolkit for building beautiful, natively compiled applications for mobile, web, and desktop from a single codebase.</p>
</blockquote>
<p>1、Flutter 是一个跨平台的 UI 库，专注于构建高效的 UI。</br><br>2、多平台的支持，下图是 Flutter 目前支持的平台，每个平台的都有自己的平台特性。</br></p>
<p><img src="http://p0.qhimg.com/t01b3f704dcfed0e4ab.png" width="70%" height="70%" /> </br></p>
<p>基于以上两点，目前 Flutter 如果要和平台相关的部分通信需要有一个通道即 PlatformChannel。</p>
<h3 id="2-架构图"><a href="#2-架构图" class="headerlink" title="2. 架构图"></a>2. 架构图</h3><img src="https://flutter.dev/images/PlatformChannels.png" width="70%" height="70%" /> 

<h3 id="3-PlatformChannel-类型"><a href="#3-PlatformChannel-类型" class="headerlink" title="3. PlatformChannel 类型"></a>3. PlatformChannel 类型</h3><ul>
<li>BasicMessageChannel：用于数据传递。platform 和 dart 可互相传递数据（asynchronous message passing）</li>
<li>MethodChannel：用于传递方法调用。platform 和 dart 可互相调用方法（asynchronous method calls）</li>
<li>EventChannel：用于数据流通信。建立连接之后，platform 发送消息，dart 接收消息（event streams）</li>
</ul>
<p>三种类型的 channel 都定义在 <code>platform_channel.dart</code> 中，从源码中可以看到三种 channel 都用到了以下三个属性。</p>
<ul>
<li><code>name</code>：String 类型，表示 channel 的名字，全局唯一（The logical channel on which communication happens）</li>
<li><code>codec</code>：MessageCodec<T> 类型，消息的编码解码器（The message codec used by this channel）</li>
<li><code>binaryMessenger</code>：BinaryMessenger类型，用于发送数据（The messenger used by this channel to send platform messages）</li>
</ul>
<h4 id="3-1-channel-name"><a href="#3-1-channel-name" class="headerlink" title="3.1 channel name"></a>3.1 channel name</h4><p>channel 的名字，每个 Flutter 应用可能有多个 channel，但是每个 channel 必须有一个唯一的名字。</p>
<h4 id="3-2-codec"><a href="#3-2-codec" class="headerlink" title="3.2 codec"></a>3.2 codec</h4><p>codec 用来对数据编码解码，以便两端可以正确读取数据。<br><img src="http://p0.qhimg.com/t01d0c790e129c2c8f9.png"/> </p>
<h4 id="3-3-binaryMessenger"><a href="#3-3-binaryMessenger" class="headerlink" title="3.3 binaryMessenger"></a>3.3 binaryMessenger</h4><p>用于发送数据</p>
<h3 id="4-PlatformChannel-使用"><a href="#4-PlatformChannel-使用" class="headerlink" title="4. PlatformChannel 使用"></a>4. PlatformChannel 使用</h3><h4 id="4-1-MethodChannel"><a href="#4-1-MethodChannel" class="headerlink" title="4.1 MethodChannel"></a>4.1 MethodChannel</h4><ul>
<li>Dart 调用 Android 方法</li>
</ul>
<p>method_channel_page.dart 主要代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">第一步</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> methodChannel = MethodChannel(<span class="string">"method_channel_sample"</span>);</span><br><span class="line"></span><br><span class="line">第二步  </span><br><span class="line">Future&lt;<span class="keyword">dynamic</span>&gt; getUserInfo(<span class="built_in">String</span> method, &#123;<span class="built_in">String</span> userName&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> methodChannel.invokeMethod(method, userName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">第三步    </span><br><span class="line">MaterialButton(</span><br><span class="line">  color: Colors.blue,</span><br><span class="line">  textColor: Colors.white,</span><br><span class="line">  child: <span class="keyword">new</span> Text(<span class="string">'获取 snow 用户信息'</span>),</span><br><span class="line">  onPressed: () &#123;</span><br><span class="line">    getUserInfo(<span class="string">"getInfo"</span>, userName: <span class="string">"snow"</span>)</span><br><span class="line">      ..then((result) &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">          messageFromNative = result;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p>MainActivity.java 主要代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addMethodChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mMethodChannel = <span class="keyword">new</span> MethodChannel(getFlutterView(), <span class="string">"method_channel_sample"</span>);</span><br><span class="line">    mMethodChannel.setMethodCallHandler((methodCall, result) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        String method = methodCall.method;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"getInfo"</span>.equals(method)) &#123;</span><br><span class="line"></span><br><span class="line">            String userName = (String) methodCall.arguments;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (userName.equals(<span class="string">"rocx"</span>)) &#123;</span><br><span class="line">                String user = <span class="string">"name:rocx, age:18"</span>;</span><br><span class="line">                result.success(user);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result.success(<span class="string">"user not found"</span>);</span><br><span class="line"></span><br><span class="line">                invokeSayHelloMethod();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从以上代码可以看出</br><br>Dart 调用 Android 代码分三步。首先在 Dart 端定义 MethodChannel 名字为 <code>method_channel_sample</code>。然后定义<code>getUserInfo</code>方法，传入要调用的方法名和参数。最后点击按钮执行方法，获取用户信息。</br><br>在 Android 端定一个 MethodChannel 名字和 Dart 端保持一致。设置 MethodCallHandler。当调用的是<code>getInfo</code>方法时，根据参数返回信息。</p>
<ul>
<li>Android 调用 Dart 方法</li>
</ul>
<p>MainActivity.java 主要代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeSayHelloMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mMethodChannel.invokeMethod(<span class="string">"sayHello"</span>, <span class="string">""</span>, <span class="keyword">new</span> MethodChannel.Result() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">success</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, o.toString(), Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String s, String s1, Object o)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notImplemented</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>method_channel_page.dart 主要代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="keyword">dynamic</span>&gt; addHandler(MethodCall call) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (call.method) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"sayHello"</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Hello from Flutter"</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> initState() &#123;</span><br><span class="line">  <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">  methodChannel.setMethodCallHandler(addHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码可以看出，在 Dart 端设置 MethodCallHandler 然后在 Android 端调用即可。</p>
<h4 id="4-2-BasicMessageChannel"><a href="#4-2-BasicMessageChannel" class="headerlink" title="4.2 BasicMessageChannel"></a>4.2 BasicMessageChannel</h4><ul>
<li>Dart 向 Android 发送消息</li>
</ul>
<p>basic_message_channel_page.dart 主要代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">第一步</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> basicMessageChannel = BasicMessageChannel(</span><br><span class="line">      <span class="string">"basic_message_channel_sample"</span>, StandardMessageCodec());</span><br><span class="line"></span><br><span class="line">第二步</span><br><span class="line">Future&lt;<span class="keyword">dynamic</span>&gt; sayHelloToNative(<span class="built_in">String</span> message) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">String</span> reply = <span class="keyword">await</span> basicMessageChannel.send(message);</span><br><span class="line"></span><br><span class="line">  setState(() &#123;</span><br><span class="line">    msgReplyFromNative = reply;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reply;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">第三步</span><br><span class="line">MaterialButton(</span><br><span class="line">  color: Colors.blue,</span><br><span class="line">  textColor: Colors.white,</span><br><span class="line">  child: <span class="keyword">new</span> Text(<span class="string">'say hello to native'</span>),</span><br><span class="line">  onPressed: () &#123;</span><br><span class="line">    sayHelloToNative(<span class="string">"hello"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p>MainActivity.java 主要代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addBasicMessageChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mBasicMessageChannel = <span class="keyword">new</span> BasicMessageChannel&lt;&gt;(getFlutterView(), <span class="string">"basic_message_channel_sample"</span>, StandardMessageCodec.INSTANCE);</span><br><span class="line">    mBasicMessageChannel.setMessageHandler((object, reply) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        reply.reply(<span class="string">"receive "</span> + object.toString() + <span class="string">" from flutter"</span>);</span><br><span class="line"></span><br><span class="line">        mBasicMessageChannel.send(<span class="string">"native say hello to flutter"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上代码可以看出</br><br>Dart 向 Android 发送消息依然分为三步。首先在 Dart 端定义 BasicMessageChannel 名字为 <code>basic_message_channel_sample</code>。然后定义发送消息的方法<code>sayHelloToNative</code>。最后点击按钮向 Android 端发送消息。</br><br>在 Android 端定一个 BasicMessageChannel 名字和 Dart 端保持一致。设置 MethodCallHandler。当收到消息时发一个回复。</p>
<ul>
<li>Android 向 Dart 发送消息</li>
</ul>
<p>MainActivity.java 主要代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mBasicMessageChannel.send(<span class="string">"native say hello to flutter"</span>);</span><br></pre></td></tr></table></figure>

<p>basic_message_channel_page.dart 主要代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="keyword">dynamic</span>&gt; addHandler(<span class="built_in">Object</span> result) <span class="keyword">async</span> &#123;</span><br><span class="line">  setState(() &#123;</span><br><span class="line">    msgReceiveFromNative = result.toString();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> addMessageListener() &#123;</span><br><span class="line">  basicMessageChannel.setMessageHandler(addHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> initState() &#123;</span><br><span class="line">  <span class="keyword">super</span>.initState();</span><br><span class="line">  addMessageListener();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码可以看出，在 Dart 端设置 MessageHandler 然后在 Android 端直接发送消息即可。</p>
<h4 id="4-3-EventChannel"><a href="#4-3-EventChannel" class="headerlink" title="4.3 EventChannel"></a>4.3 EventChannel</h4><p>event_channel_page.dart 主要代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">第一步</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> eventChannel = EventChannel(<span class="string">"event_channel_sample"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _onEvent(<span class="built_in">Object</span> event) &#123;</span><br><span class="line">  setState(() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_streamSubscription != <span class="keyword">null</span>) &#123;</span><br><span class="line">      eventMessage = event.toString();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _onError(<span class="built_in">Object</span> error) &#123;</span><br><span class="line">  setState(() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_streamSubscription != <span class="keyword">null</span>) &#123;</span><br><span class="line">      eventMessage = <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> initState() &#123;</span><br><span class="line">  <span class="keyword">super</span>.initState();</span><br><span class="line">  eventMessage = <span class="string">""</span>;</span><br><span class="line">  第二步</span><br><span class="line">  _streamSubscription = eventChannel</span><br><span class="line">      .receiveBroadcastStream()</span><br><span class="line">      .listen(_onEvent, onError: _onError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MainActivity.java 主要代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addEventChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mEventChannel = <span class="keyword">new</span> EventChannel(getFlutterView(), <span class="string">"event_channel_sample"</span>);</span><br><span class="line">    mEventChannel.setStreamHandler(<span class="keyword">new</span> EventChannel.StreamHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onListen</span><span class="params">(Object o, EventChannel.EventSink eventSink)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            task = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    runOnUiThread(() -&gt; eventSink.success(<span class="string">"i miss you "</span> + System.currentTimeMillis()));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            timer = <span class="keyword">new</span> Timer();</span><br><span class="line">            timer.schedule(task, <span class="number">2000</span>, <span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCancel</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            task.cancel();</span><br><span class="line">            timer.cancel();</span><br><span class="line">            task = <span class="keyword">null</span>;</span><br><span class="line">            timer = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dart 接受 Android stream event。首先在 Dart 端定义 EventChannel 名字为 <code>event_channel_sample</code>。然后设置<code>receiveBroadcastStream</code>监听，当 Android 端有消息发过来会回调<code>_onEvent</code>方法。</br><br>在 Android 端启动一个定时器，每隔3s向 Dart 端发送一次消息。</p>
<h4 id="4-4-总结"><a href="#4-4-总结" class="headerlink" title="4.4 总结"></a>4.4 总结</h4><p>如下图，在 Dart 与 Platform 通信过程中，通过 channel name 找到对方，然后把消息通过 codec 进行编解码，最后通过 binaryMessenger 进行发送。<br><img src="http://p0.qhimg.com/t01d23cfd7ce4e80077.png"/> </p>
<h3 id="5-源码分析-以-MethodChannel-为例"><a href="#5-源码分析-以-MethodChannel-为例" class="headerlink" title="5. 源码分析-以 MethodChannel 为例"></a>5. 源码分析-以 MethodChannel 为例</h3><h5 id="5-1-调用-MethodChannel-的-invokeMethod-方法，会调用到-binaryMessenger-send-方法。即-binaryMessenger-send-传入-channel-name-和编码好的参数。"><a href="#5-1-调用-MethodChannel-的-invokeMethod-方法，会调用到-binaryMessenger-send-方法。即-binaryMessenger-send-传入-channel-name-和编码好的参数。" class="headerlink" title="5.1 调用 MethodChannel 的 invokeMethod 方法，会调用到 binaryMessenger.send 方法。即 binaryMessenger.send 传入 channel name 和编码好的参数。"></a>5.1 调用 MethodChannel 的 invokeMethod 方法，会调用到 binaryMessenger.send 方法。即 binaryMessenger.send 传入 channel name 和编码好的参数。</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@optionalTypeArgs</span></span><br><span class="line">Future&lt;T&gt; invokeMethod&lt;T&gt;(<span class="built_in">String</span> method, [ <span class="keyword">dynamic</span> arguments ]) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">assert</span>(method != <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">final</span> ByteData result = <span class="keyword">await</span> binaryMessenger.send(</span><br><span class="line">    name,</span><br><span class="line">    codec.encodeMethodCall(MethodCall(method, arguments)),</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> MissingPluginException(<span class="string">'No implementation found for method <span class="subst">$method</span> on channel <span class="subst">$name</span>'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> T typedResult = codec.decodeEnvelope(result);</span><br><span class="line">  <span class="keyword">return</span> typedResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-binary-messenger-dart-的-send-方法会调用当前对象的-sendPlatformMessage-方法，最终会调用-window-sendPlatformMessage-方法。"><a href="#5-2-binary-messenger-dart-的-send-方法会调用当前对象的-sendPlatformMessage-方法，最终会调用-window-sendPlatformMessage-方法。" class="headerlink" title="5.2 binary_messenger.dart 的 send 方法会调用当前对象的 _sendPlatformMessage 方法，最终会调用 window.sendPlatformMessage 方法。"></a>5.2 binary_messenger.dart 的 send 方法会调用当前对象的 _sendPlatformMessage 方法，最终会调用 window.sendPlatformMessage 方法。</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Future&lt;ByteData&gt; send(<span class="built_in">String</span> channel, ByteData message) &#123;</span><br><span class="line">  <span class="keyword">final</span> MessageHandler handler = _mockHandlers[channel];</span><br><span class="line">  <span class="keyword">if</span> (handler != <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">return</span> handler(message);</span><br><span class="line">  <span class="keyword">return</span> _sendPlatformMessage(channel, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;ByteData&gt; _sendPlatformMessage(<span class="built_in">String</span> channel, ByteData message) &#123;</span><br><span class="line">  <span class="keyword">final</span> Completer&lt;ByteData&gt; completer = Completer&lt;ByteData&gt;();</span><br><span class="line">  <span class="comment">// ui.window is accessed directly instead of using ServicesBinding.instance.window</span></span><br><span class="line">  <span class="comment">// because this method might be invoked before any binding is initialized.</span></span><br><span class="line">  <span class="comment">// This issue was reported in #27541. It is not ideal to statically access</span></span><br><span class="line">  <span class="comment">// ui.window because the Window may be dependency injected elsewhere with</span></span><br><span class="line">  <span class="comment">// a different instance. However, static access at this location seems to be</span></span><br><span class="line">  <span class="comment">// the least bad option.</span></span><br><span class="line">  ui.<span class="built_in">window</span>.sendPlatformMessage(channel, message, (ByteData reply) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      completer.complete(reply);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (exception, stack) &#123;</span><br><span class="line">      FlutterError.reportError(FlutterErrorDetails(</span><br><span class="line">        exception: exception,</span><br><span class="line">        stack: stack,</span><br><span class="line">        <span class="keyword">library</span>: <span class="string">'services library'</span>,</span><br><span class="line">        context: ErrorDescription(<span class="string">'during a platform message response callback'</span>),</span><br><span class="line">      ));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> completer.future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-3-在-window-dart-中又调用了-native-方法-sendPlatformMessage。"><a href="#5-3-在-window-dart-中又调用了-native-方法-sendPlatformMessage。" class="headerlink" title="5.3 在 window.dart 中又调用了 native 方法 _sendPlatformMessage。"></a>5.3 在 window.dart 中又调用了 native 方法 _sendPlatformMessage。</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> sendPlatformMessage(<span class="built_in">String</span> name,</span><br><span class="line">                         ByteData data,</span><br><span class="line">                         PlatformMessageResponseCallback callback) &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> error =</span><br><span class="line">      _sendPlatformMessage(name, _zonedPlatformMessageResponseCallback(callback), data);</span><br><span class="line">  <span class="keyword">if</span> (error != <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> Exception(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span> _sendPlatformMessage(<span class="built_in">String</span> name,</span><br><span class="line">                            PlatformMessageResponseCallback callback,</span><br><span class="line">                            ByteData data) native <span class="string">'Window_sendPlatformMessage'</span>;</span><br></pre></td></tr></table></figure>
<h5 id="5-4-接下来进入-engine-中的-window-cc，可以看到最终调用的是-dart-state-gt-window-gt-client-gt-HandlePlatformMessage。"><a href="#5-4-接下来进入-engine-中的-window-cc，可以看到最终调用的是-dart-state-gt-window-gt-client-gt-HandlePlatformMessage。" class="headerlink" title="5.4 接下来进入 engine 中的 window.cc，可以看到最终调用的是 dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage。"></a>5.4 接下来进入 engine 中的 window.cc，可以看到最终调用的是 dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Window::RegisterNatives(tonic::DartLibraryNatives* natives) &#123;</span><br><span class="line">  natives-&gt;Register(&#123;</span><br><span class="line">      &#123;<span class="string">"Window_defaultRouteName"</span>, DefaultRouteName, <span class="number">1</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_scheduleFrame"</span>, ScheduleFrame, <span class="number">1</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_sendPlatformMessage"</span>, _SendPlatformMessage, <span class="number">4</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_respondToPlatformMessage"</span>, _RespondToPlatformMessage, <span class="number">3</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_render"</span>, Render, <span class="number">2</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_updateSemantics"</span>, UpdateSemantics, <span class="number">2</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_setIsolateDebugName"</span>, SetIsolateDebugName, <span class="number">2</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_reportUnhandledException"</span>, ReportUnhandledException, <span class="number">2</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">      &#123;<span class="string">"Window_setNeedsReportTimings"</span>, SetNeedsReportTimings, <span class="number">2</span>, <span class="literal">true</span>&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _SendPlatformMessage(Dart_NativeArguments args) &#123;</span><br><span class="line">  tonic::DartCallStatic(&amp;SendPlatformMessage, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Dart_Handle <span class="title">SendPlatformMessage</span><span class="params">(Dart_Handle window,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Dart_Handle callback,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Dart_Handle data_handle)</span> </span>&#123;</span><br><span class="line">  UIDartState* dart_state = UIDartState::Current();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dart_state-&gt;window()) &#123;</span><br><span class="line">    <span class="keyword">return</span> tonic::ToDart(</span><br><span class="line">        <span class="string">"Platform messages can only be sent from the main isolate"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fml::RefPtr&lt;PlatformMessageResponse&gt; response;</span><br><span class="line">  <span class="keyword">if</span> (!Dart_IsNull(callback)) &#123;</span><br><span class="line">    response = fml::MakeRefCounted&lt;PlatformMessageResponseDart&gt;(</span><br><span class="line">        tonic::DartPersistentValue(dart_state, callback),</span><br><span class="line">        dart_state-&gt;GetTaskRunners().GetUITaskRunner());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Dart_IsNull(data_handle)) &#123;</span><br><span class="line">    dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage(</span><br><span class="line">        fml::MakeRefCounted&lt;PlatformMessage&gt;(name, response));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    tonic::DartByteData data(data_handle);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* buffer = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span>*&gt;(data.data());</span><br><span class="line">    dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage(</span><br><span class="line">        fml::MakeRefCounted&lt;PlatformMessage&gt;(</span><br><span class="line">            name, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt;(buffer, buffer + data.length_in_bytes()),</span><br><span class="line">            response));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Dart_Null();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/master/lib/ui/window/window.cc" target="_blank" rel="noopener">window.cc 源码</a></p>
</blockquote>
<h5 id="5-5-我们进入-window-h-中找到-client-其实是-WindowClient。"><a href="#5-5-我们进入-window-h-中找到-client-其实是-WindowClient。" class="headerlink" title="5.5 我们进入 window.h 中找到 client 其实是 WindowClient。"></a>5.5 我们进入 window.h 中找到 client 其实是 WindowClient。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WindowClient* <span class="title">client</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> client_; &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/master/lib/ui/window/window.h" target="_blank" rel="noopener">window.h 源码</a></p>
</blockquote>
<h5 id="5-6-在-runtime-controller-h-中可以看到-RuntimeController-是-WindowClient-的实际实现，调用的是-RuntimeController-的-HandlePlatformMessage-方法。"><a href="#5-6-在-runtime-controller-h-中可以看到-RuntimeController-是-WindowClient-的实际实现，调用的是-RuntimeController-的-HandlePlatformMessage-方法。" class="headerlink" title="5.6 在 runtime_controller.h 中可以看到 RuntimeController 是 WindowClient 的实际实现，调用的是 RuntimeController 的 HandlePlatformMessage 方法。"></a>5.6 在 runtime_controller.h 中可以看到 RuntimeController 是 WindowClient 的实际实现，调用的是 RuntimeController 的 HandlePlatformMessage 方法。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RuntimeController</span> <span class="title">final</span> :</span> <span class="keyword">public</span> WindowClient &#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  <span class="comment">// |WindowClient|</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">HandlePlatformMessage</span><span class="params">(fml::RefPtr&lt;PlatformMessage&gt; message)</span> override</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/runtime/runtime_controller.h" target="_blank" rel="noopener">runtime_controller.h 源码</a></p>
</blockquote>
<h5 id="5-7-在-runtime-controller-cc-中，HandlePlatformMessage-调用了-client-的-HandlePlatformMessage-方法，client-实际是代理对象-RuntimeDelegate。"><a href="#5-7-在-runtime-controller-cc-中，HandlePlatformMessage-调用了-client-的-HandlePlatformMessage-方法，client-实际是代理对象-RuntimeDelegate。" class="headerlink" title="5.7 在 runtime_controller.cc 中，HandlePlatformMessage 调用了 client_ 的 HandlePlatformMessage 方法，client_ 实际是代理对象 RuntimeDelegate。"></a>5.7 在 runtime_controller.cc 中，HandlePlatformMessage 调用了 client_ 的 HandlePlatformMessage 方法，client_ 实际是代理对象 RuntimeDelegate。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RuntimeController::HandlePlatformMessage(</span><br><span class="line">    fml::RefPtr&lt;PlatformMessage&gt; message) &#123;</span><br><span class="line">  client_.HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RuntimeDelegate&amp; p_client</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/runtime/runtime_controller.cc" target="_blank" rel="noopener">runtime_controller.cc 源码</a></p>
</blockquote>
<h5 id="5-8-engine-h-是-RuntimeDelegate-的具体实现类。"><a href="#5-8-engine-h-是-RuntimeDelegate-的具体实现类。" class="headerlink" title="5.8 engine.h 是 RuntimeDelegate 的具体实现类。"></a>5.8 engine.h 是 RuntimeDelegate 的具体实现类。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Engine</span> <span class="title">final</span> :</span> <span class="keyword">public</span> RuntimeDelegate &#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// |RuntimeDelegate|</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">HandlePlatformMessage</span><span class="params">(fml::RefPtr&lt;PlatformMessage&gt; message)</span> override</span>;</span><br><span class="line">...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/shell/common/engine.h" target="_blank" rel="noopener">engine.h 源码</a></p>
</blockquote>
<h5 id="5-9-engine-cc-中调用了-delegate-的-OnEngineHandlePlatformMessage-方法。"><a href="#5-9-engine-cc-中调用了-delegate-的-OnEngineHandlePlatformMessage-方法。" class="headerlink" title="5.9 engine.cc 中调用了 delegate_ 的 OnEngineHandlePlatformMessage 方法。"></a>5.9 engine.cc 中调用了 delegate_ 的 OnEngineHandlePlatformMessage 方法。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Engine::HandlePlatformMessage(fml::RefPtr&lt;PlatformMessage&gt; message) &#123;</span><br><span class="line">  <span class="keyword">if</span> (message-&gt;channel() == kAssetChannel) &#123;</span><br><span class="line">    HandleAssetPlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    delegate_.OnEngineHandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/shell/common/engine.cc" target="_blank" rel="noopener">engine.cc 源码</a></p>
</blockquote>
<h5 id="5-10-shell-h-是-Engine-的代理。"><a href="#5-10-shell-h-是-Engine-的代理。" class="headerlink" title="5.10 shell.h 是 Engine 的代理。"></a>5.10 shell.h 是 Engine 的代理。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |Engine::Delegate|</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnEngineHandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fml::RefPtr&lt;PlatformMessage&gt; message)</span> override</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/ed8e35c4cfe12f836133944c968e00ca52593d43/shell/common/shell.h" target="_blank" rel="noopener">shell.h 源码</a></p>
</blockquote>
<h5 id="5-11-调用流程又进入了-shell-cc-的-HandleEngineSkiaMessage-方法，把消费放到-TaskRunner-中。"><a href="#5-11-调用流程又进入了-shell-cc-的-HandleEngineSkiaMessage-方法，把消费放到-TaskRunner-中。" class="headerlink" title="5.11 调用流程又进入了 shell.cc 的 HandleEngineSkiaMessage 方法，把消费放到 TaskRunner 中。"></a>5.11 调用流程又进入了 shell.cc 的 HandleEngineSkiaMessage 方法，把消费放到 TaskRunner 中。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |Engine::Delegate|</span></span><br><span class="line"><span class="keyword">void</span> Shell::OnEngineHandlePlatformMessage(</span><br><span class="line">    fml::RefPtr&lt;PlatformMessage&gt; message) &#123;</span><br><span class="line">  FML_DCHECK(is_setup_);</span><br><span class="line">  FML_DCHECK(task_runners_.GetUITaskRunner()-&gt;RunsTasksOnCurrentThread());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (message-&gt;channel() == kSkiaChannel) &#123;</span><br><span class="line">    HandleEngineSkiaMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  task_runners_.GetPlatformTaskRunner()-&gt;PostTask(</span><br><span class="line">      [view = platform_view_-&gt;GetWeakPtr(), message = <span class="built_in">std</span>::move(message)]() &#123;</span><br><span class="line">        <span class="keyword">if</span> (view) &#123;</span><br><span class="line">          view-&gt;HandlePlatformMessage(<span class="built_in">std</span>::move(message));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/ed8e35c4cfe12f836133944c968e00ca52593d43/shell/common/shell.cc" target="_blank" rel="noopener">shell.cc 源码</a></p>
</blockquote>
<h5 id="5-12-当-task-执行是会调用-platform-view-android-h-的-HandlePlatformMessage-方法。"><a href="#5-12-当-task-执行是会调用-platform-view-android-h-的-HandlePlatformMessage-方法。" class="headerlink" title="5.12 当 task 执行是会调用 platform_view_android.h 的 HandlePlatformMessage 方法。"></a>5.12 当 task 执行是会调用 platform_view_android.h 的 HandlePlatformMessage 方法。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlatformViewAndroid</span> <span class="title">final</span> :</span> <span class="keyword">public</span> PlatformView &#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// |PlatformView|</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">HandlePlatformMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      fml::RefPtr&lt;flutter::PlatformMessage&gt; message)</span> override</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/56052c70afcbdff2d39d2af279fcc52666122dbf/shell/platform/android/platform_view_android.h" target="_blank" rel="noopener">platform_view_android.h 源码</a> </p>
</blockquote>
<h5 id="5-13-在-platform-view-android-cc-的-HandlePlatformMessage-中，开始通过-jni-调用-java-端的方法，java-channel-即要找的-channel。"><a href="#5-13-在-platform-view-android-cc-的-HandlePlatformMessage-中，开始通过-jni-调用-java-端的方法，java-channel-即要找的-channel。" class="headerlink" title="5.13 在 platform_view_android.cc 的 HandlePlatformMessage 中，开始通过 jni 调用 java 端的方法，java_channel 即要找的 channel。"></a>5.13 在 platform_view_android.cc 的 HandlePlatformMessage 中，开始通过 jni 调用 java 端的方法，java_channel 即要找的 channel。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |PlatformView|</span></span><br><span class="line"><span class="keyword">void</span> PlatformViewAndroid::HandlePlatformMessage(</span><br><span class="line">    fml::RefPtr&lt;flutter::PlatformMessage&gt; message) &#123;</span><br><span class="line">  JNIEnv* env = fml::jni::AttachCurrentThread();</span><br><span class="line">  fml::jni::ScopedJavaLocalRef&lt;jobject&gt; view = java_object_.get(env);</span><br><span class="line">  <span class="keyword">if</span> (view.is_null())</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> response_id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span> response = message-&gt;response()) &#123;</span><br><span class="line">    response_id = next_response_id_++;</span><br><span class="line">    pending_responses_[response_id] = response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> java_channel = fml::jni::StringToJavaString(env, message-&gt;channel());</span><br><span class="line">  <span class="keyword">if</span> (message-&gt;hasData()) &#123;</span><br><span class="line">    fml::jni::ScopedJavaLocalRef&lt;jbyteArray&gt; message_array(</span><br><span class="line">        env, env-&gt;NewByteArray(message-&gt;data().size()));</span><br><span class="line">    env-&gt;SetByteArrayRegion(</span><br><span class="line">        message_array.obj(), <span class="number">0</span>, message-&gt;data().size(),</span><br><span class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> jbyte*&gt;(message-&gt;data().data()));</span><br><span class="line">    message = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This call can re-enter in InvokePlatformMessageXxxResponseCallback.</span></span><br><span class="line">    FlutterViewHandlePlatformMessage(env, view.obj(), java_channel.obj(),</span><br><span class="line">                                     message_array.obj(), response_id);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    message = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This call can re-enter in InvokePlatformMessageXxxResponseCallback.</span></span><br><span class="line">    FlutterViewHandlePlatformMessage(env, view.obj(), java_channel.obj(),</span><br><span class="line">                                     <span class="literal">nullptr</span>, response_id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/56052c70afcbdff2d39d2af279fcc52666122dbf/shell/platform/android/platform_view_android.cc" target="_blank" rel="noopener">platform_view_android.cc 源码</a></p>
</blockquote>
<h5 id="5-14-在-platform-view-android-jni-cc-中可以看到-g-handle-platform-message-method-就是-FindClass-“io-flutter-embedding-engine-FlutterJNI”-类的-handlePlatformMessage-方法。至此-engine-代码执行结束。"><a href="#5-14-在-platform-view-android-jni-cc-中可以看到-g-handle-platform-message-method-就是-FindClass-“io-flutter-embedding-engine-FlutterJNI”-类的-handlePlatformMessage-方法。至此-engine-代码执行结束。" class="headerlink" title="5.14 在 platform_view_android_jni.cc 中可以看到 g_handle_platform_message_method 就是 FindClass(“io/flutter/embedding/engine/FlutterJNI”) 类的 handlePlatformMessage 方法。至此 engine 代码执行结束。"></a>5.14 在 platform_view_android_jni.cc 中可以看到 g_handle_platform_message_method 就是 FindClass(“io/flutter/embedding/engine/FlutterJNI”) 类的 handlePlatformMessage 方法。至此 engine 代码执行结束。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> jmethodID g_handle_platform_message_method = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FlutterViewHandlePlatformMessage</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      jobject obj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      jstring channel,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      jobject message,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      jint responseId)</span> </span>&#123;</span><br><span class="line">  env-&gt;CallVoidMethod(obj, g_handle_platform_message_method, channel, message,</span><br><span class="line">                      responseId);</span><br><span class="line">  FML_CHECK(CheckException(env));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g_handle_platform_message_method =</span><br><span class="line">    env-&gt;GetMethodID(g_flutter_jni_class-&gt;obj(), <span class="string">"handlePlatformMessage"</span>,</span><br><span class="line">                     <span class="string">"(Ljava/lang/String;[BI)V"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">g_flutter_jni_class = <span class="keyword">new</span> fml::jni::ScopedJavaGlobalRef&lt;jclass&gt;(</span><br><span class="line">    env, env-&gt;FindClass(<span class="string">"io/flutter/embedding/engine/FlutterJNI"</span>));</span><br><span class="line"><span class="keyword">if</span> (g_flutter_jni_class-&gt;is_null()) &#123;</span><br><span class="line">  FML_LOG(ERROR) &lt;&lt; <span class="string">"Failed to find FlutterJNI Class."</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/flutter/engine/blob/ed8e35c4cfe12f836133944c968e00ca52593d43/shell/platform/android/platform_view_android_jni.cc" target="_blank" rel="noopener">platform_view_android_jni.cc 源码</a></p>
</blockquote>
<h5 id="5-15-在-FlutterJNI-中调用了-this-platformMessageHandler-handleMessageFromDart-方法。也就是-DartMessenger-的-handleMessageFromDart-方法。"><a href="#5-15-在-FlutterJNI-中调用了-this-platformMessageHandler-handleMessageFromDart-方法。也就是-DartMessenger-的-handleMessageFromDart-方法。" class="headerlink" title="5.15 在 FlutterJNI 中调用了 this.platformMessageHandler.handleMessageFromDart 方法。也就是 DartMessenger 的 handleMessageFromDart 方法。"></a>5.15 在 FlutterJNI 中调用了 this.platformMessageHandler.handleMessageFromDart 方法。也就是 DartMessenger 的 handleMessageFromDart 方法。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePlatformMessage</span><span class="params">(@NonNull String channel, <span class="keyword">byte</span>[] message, <span class="keyword">int</span> replyId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.platformMessageHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.platformMessageHandler.handleMessageFromDart(channel, message, replyId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-16-DartMessenger-中-messageHandlers-通过-channel-名找到对应的-handler-进行处理，这个-handler-就是我们在-java-代码里通过-channel-设置的，整个调用流程完成。"><a href="#5-16-DartMessenger-中-messageHandlers-通过-channel-名找到对应的-handler-进行处理，这个-handler-就是我们在-java-代码里通过-channel-设置的，整个调用流程完成。" class="headerlink" title="5.16 DartMessenger 中 messageHandlers 通过 channel 名找到对应的 handler 进行处理，这个 handler 就是我们在 java 代码里通过 channel 设置的，整个调用流程完成。"></a>5.16 DartMessenger 中 messageHandlers 通过 channel 名找到对应的 handler 进行处理，这个 handler 就是我们在 java 代码里通过 channel 设置的，整个调用流程完成。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessageFromDart</span><span class="params">(@NonNull String channel, @Nullable <span class="keyword">byte</span>[] message, <span class="keyword">int</span> replyId)</span> </span>&#123;</span><br><span class="line">    Log.v(<span class="string">"DartMessenger"</span>, <span class="string">"Received message from Dart over channel '"</span> + channel + <span class="string">"'"</span>);</span><br><span class="line">    BinaryMessageHandler handler = (BinaryMessageHandler)<span class="keyword">this</span>.messageHandlers.get(channel);</span><br><span class="line">    <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Log.v(<span class="string">"DartMessenger"</span>, <span class="string">"Deferring to registered handler to process message."</span>);</span><br><span class="line">            ByteBuffer buffer = message == <span class="keyword">null</span> ? <span class="keyword">null</span> : ByteBuffer.wrap(message);</span><br><span class="line">            handler.onMessage(buffer, <span class="keyword">new</span> DartMessenger.Reply(<span class="keyword">this</span>.flutterJNI, replyId));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">            Log.e(<span class="string">"DartMessenger"</span>, <span class="string">"Uncaught exception in binary message listener"</span>, var6);</span><br><span class="line">            <span class="keyword">this</span>.flutterJNI.invokePlatformMessageEmptyResponseCallback(replyId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.v(<span class="string">"DartMessenger"</span>, <span class="string">"No registered handler for message. Responding to Dart with empty reply message."</span>);</span><br><span class="line">        <span class="keyword">this</span>.flutterJNI.invokePlatformMessageEmptyResponseCallback(replyId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Demo-地址"><a href="#Demo-地址" class="headerlink" title="Demo 地址"></a>Demo 地址</h3><p><a href="https://github.com/roc-x/roc-samples/tree/master/flutter_platform_channel" target="_blank" rel="noopener">flutter_platform_channel 使用</a></p>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://flutter.dev/docs/development/platform-integration/platform-channels" target="_blank" rel="noopener">Writing custom platform-specific code</a></br><br><a href="https://github.com/flutter/flutter/tree/master/examples/platform_channel" target="_blank" rel="noopener">platform channel 官方示例</a></br><br><a href="https://www.yuque.com/xytech/flutter/fu7h25" target="_blank" rel="noopener">深入理解Flutter Platform Channel</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/project/">项目</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flutter-Platform-Channel-使用与源码分析"><span class="toc-number">1.</span> <span class="toc-text">Flutter Platform Channel 使用与源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-为什么要有-PlatformChannel"><span class="toc-number">1.1.</span> <span class="toc-text">1. 为什么要有 PlatformChannel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-架构图"><span class="toc-number">1.2.</span> <span class="toc-text">2. 架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-PlatformChannel-类型"><span class="toc-number">1.3.</span> <span class="toc-text">3. PlatformChannel 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-channel-name"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 channel name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-codec"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 codec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-binaryMessenger"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 binaryMessenger</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-PlatformChannel-使用"><span class="toc-number">1.4.</span> <span class="toc-text">4. PlatformChannel 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-MethodChannel"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 MethodChannel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-BasicMessageChannel"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 BasicMessageChannel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-EventChannel"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 EventChannel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-总结"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-源码分析-以-MethodChannel-为例"><span class="toc-number">1.5.</span> <span class="toc-text">5. 源码分析-以 MethodChannel 为例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-调用-MethodChannel-的-invokeMethod-方法，会调用到-binaryMessenger-send-方法。即-binaryMessenger-send-传入-channel-name-和编码好的参数。"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">5.1 调用 MethodChannel 的 invokeMethod 方法，会调用到 binaryMessenger.send 方法。即 binaryMessenger.send 传入 channel name 和编码好的参数。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-binary-messenger-dart-的-send-方法会调用当前对象的-sendPlatformMessage-方法，最终会调用-window-sendPlatformMessage-方法。"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">5.2 binary_messenger.dart 的 send 方法会调用当前对象的 _sendPlatformMessage 方法，最终会调用 window.sendPlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-在-window-dart-中又调用了-native-方法-sendPlatformMessage。"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">5.3 在 window.dart 中又调用了 native 方法 _sendPlatformMessage。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-接下来进入-engine-中的-window-cc，可以看到最终调用的是-dart-state-gt-window-gt-client-gt-HandlePlatformMessage。"><span class="toc-number">1.5.0.4.</span> <span class="toc-text">5.4 接下来进入 engine 中的 window.cc，可以看到最终调用的是 dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-我们进入-window-h-中找到-client-其实是-WindowClient。"><span class="toc-number">1.5.0.5.</span> <span class="toc-text">5.5 我们进入 window.h 中找到 client 其实是 WindowClient。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-6-在-runtime-controller-h-中可以看到-RuntimeController-是-WindowClient-的实际实现，调用的是-RuntimeController-的-HandlePlatformMessage-方法。"><span class="toc-number">1.5.0.6.</span> <span class="toc-text">5.6 在 runtime_controller.h 中可以看到 RuntimeController 是 WindowClient 的实际实现，调用的是 RuntimeController 的 HandlePlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-7-在-runtime-controller-cc-中，HandlePlatformMessage-调用了-client-的-HandlePlatformMessage-方法，client-实际是代理对象-RuntimeDelegate。"><span class="toc-number">1.5.0.7.</span> <span class="toc-text">5.7 在 runtime_controller.cc 中，HandlePlatformMessage 调用了 client_ 的 HandlePlatformMessage 方法，client_ 实际是代理对象 RuntimeDelegate。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-8-engine-h-是-RuntimeDelegate-的具体实现类。"><span class="toc-number">1.5.0.8.</span> <span class="toc-text">5.8 engine.h 是 RuntimeDelegate 的具体实现类。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-9-engine-cc-中调用了-delegate-的-OnEngineHandlePlatformMessage-方法。"><span class="toc-number">1.5.0.9.</span> <span class="toc-text">5.9 engine.cc 中调用了 delegate_ 的 OnEngineHandlePlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-10-shell-h-是-Engine-的代理。"><span class="toc-number">1.5.0.10.</span> <span class="toc-text">5.10 shell.h 是 Engine 的代理。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-11-调用流程又进入了-shell-cc-的-HandleEngineSkiaMessage-方法，把消费放到-TaskRunner-中。"><span class="toc-number">1.5.0.11.</span> <span class="toc-text">5.11 调用流程又进入了 shell.cc 的 HandleEngineSkiaMessage 方法，把消费放到 TaskRunner 中。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-12-当-task-执行是会调用-platform-view-android-h-的-HandlePlatformMessage-方法。"><span class="toc-number">1.5.0.12.</span> <span class="toc-text">5.12 当 task 执行是会调用 platform_view_android.h 的 HandlePlatformMessage 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-13-在-platform-view-android-cc-的-HandlePlatformMessage-中，开始通过-jni-调用-java-端的方法，java-channel-即要找的-channel。"><span class="toc-number">1.5.0.13.</span> <span class="toc-text">5.13 在 platform_view_android.cc 的 HandlePlatformMessage 中，开始通过 jni 调用 java 端的方法，java_channel 即要找的 channel。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-14-在-platform-view-android-jni-cc-中可以看到-g-handle-platform-message-method-就是-FindClass-“io-flutter-embedding-engine-FlutterJNI”-类的-handlePlatformMessage-方法。至此-engine-代码执行结束。"><span class="toc-number">1.5.0.14.</span> <span class="toc-text">5.14 在 platform_view_android_jni.cc 中可以看到 g_handle_platform_message_method 就是 FindClass(“io/flutter/embedding/engine/FlutterJNI”) 类的 handlePlatformMessage 方法。至此 engine 代码执行结束。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-15-在-FlutterJNI-中调用了-this-platformMessageHandler-handleMessageFromDart-方法。也就是-DartMessenger-的-handleMessageFromDart-方法。"><span class="toc-number">1.5.0.15.</span> <span class="toc-text">5.15 在 FlutterJNI 中调用了 this.platformMessageHandler.handleMessageFromDart 方法。也就是 DartMessenger 的 handleMessageFromDart 方法。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-16-DartMessenger-中-messageHandlers-通过-channel-名找到对应的-handler-进行处理，这个-handler-就是我们在-java-代码里通过-channel-设置的，整个调用流程完成。"><span class="toc-number">1.5.0.16.</span> <span class="toc-text">5.16 DartMessenger 中 messageHandlers 通过 channel 名找到对应的 handler 进行处理，这个 handler 就是我们在 java 代码里通过 channel 设置的，整个调用流程完成。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo-地址"><span class="toc-number">1.6.</span> <span class="toc-text">Demo 地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资源"><span class="toc-number">1.7.</span> <span class="toc-text">参考资源</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&text=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&is_video=false&description=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Flutter Platform Channel 使用与源码分析&body=Check out this article: http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&title=Flutter Platform Channel 使用与源码分析" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/08/21/Flutter%20Platform%20Channel%20%E4%BD%BF%E7%94%A8%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&name=Flutter Platform Channel 使用与源码分析&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 snow
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/project/">项目</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
